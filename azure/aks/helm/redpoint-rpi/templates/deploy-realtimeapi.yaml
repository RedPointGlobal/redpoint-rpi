apiVersion: v1
kind: Service
metadata:
  name: rpi-realtimeapi
  namespace: {{ .Values.global.namespace }}
  labels:
    app: rpi-realtimeapi
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  selector:
    app: rpi-realtimeapi

---
{{- if eq .Values.global.cloud "demo" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rpi-realtimeapi
  namespace: {{ .Values.global.namespace }}
  labels:
    app: rpi-realtimeapi
spec:
  replicas: {{ .Values.replicas.realtimeapi }}
  selector:
    matchLabels:
      app: rpi-realtimeapi
  template:
    metadata:
      labels:
        app: rpi-realtimeapi
    spec:
      serviceAccountName: redpoint-rpi
      containers:
        - name: rpi-realtimeapi
          image: rg1acrpub.azurecr.io/docker/redpointinteraction/prod/redpoint-realtime-plus-agent:{{ .Values.global.image_tag }}
          imagePullPolicy: Always
          ports:
          - containerPort: 8080
            name: web-port
            protocol: TCP
          env:
          - name: CONNECTIONSTRINGS__LOGGINGDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__LoggingDatabase
                name: database-secrets
          - name: CONNECTIONSTRINGS__OPERATIONALDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__OperationalDatabase
                name: database-secrets
          - name: RealtimeAPIConfiguration__AppSettings__PluginAssemblyPath
            value: "/app/plugins"
          volumeMounts:
            - name: rpi-realtimeapi
              mountPath: /app/appsettings
            - name: plugins
              mountPath: /app/plugins
      volumes:
        - name: rpi-realtimeapi
          configMap:
            name: rpi-realtimeapi
        - name: plugins
          emptyDir: {}
{{- end }}

---
{{- if eq .Values.global.cloud "amazon" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rpi-realtimeapi
  namespace: {{ .Values.global.namespace }}
  labels:
    app: rpi-realtimeapi
spec:
  replicas: {{ .Values.replicas.realtimeapi }}
  selector:
    matchLabels:
      app: rpi-realtimeapi
  template:
    metadata:
      labels:
        app: rpi-realtimeapi
    spec:
      imagePullSecrets:
        - name: redpoint-rpi
      serviceAccountName: redpoint-rpi
      containers:
        - name: rpi-realtimeapi
          image: rg1acrpub.azurecr.io/docker/redpointinteraction/prod/redpoint-realtime-plus-agent:{{ .Values.global.image_tag }}
          imagePullPolicy: Always
          ports:
          - containerPort: 8080
            name: web-port
            protocol: TCP
          env:
          - name: CONNECTIONSTRINGS__LOGGINGDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__LoggingDatabase
                name: database-secrets
          - name: CONNECTIONSTRINGS__OPERATIONALDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__OperationalDatabase
                name: database-secrets
          - name: RealtimeAPIConfiguration__AppSettings__PluginAssemblyPath
            value: {{ .Values.realtime.pluginAssemblyPath | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentInProcessEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__NoDaysPersistWebEvents
            value: {{ .Values.realtime.NoDaysPersistWebEvents | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CacheWebFormData
            value: {{ .Values.realtime.CacheWebFormData | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableHelpPages
            value: {{ .Values.realtime.enableHelpPages | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CORSOrigins
            value: {{ .Values.realtime.CORSOrigins | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__DecisionCacheDuration
            value: {{ .Values.realtime.decisionCacheDuration | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIClientID
            value: {{ .Values.realtime.rpiClientID | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAPIKey
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableAuditMetricsInHeaders
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__EnableEventListening
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__FormQueuePath
            value: {{ .Values.queueNames.formQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__EventsQueuePath
            value: {{ .Values.queueNames.eventsQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueueEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueuePath
            value: {{ .Values.queueNames.cacheOutputQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__RecommendationsQueuePath
            value: {{ .Values.queueNames.recommendationsQueuePath | quote }}
          {{- if eq .Values.queueProviders.type "amazonsqs" }}
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Assembly
            value: "RedPoint.Amazon.Server"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Type
            value: "RedPoint.Amazon.Server.AWSQueue.SQSQueueFactory"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Key
            value: "AccessKey"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Value
            value: {{ .Values.queueProviders.amazonsqs.accessKey | quote }}
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__1__Key
            value: "SecretKey"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__1__Value
            value: {{ .Values.queueProviders.amazonsqs.secretKey | quote }}
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__2__Key
            value: "RegionEndpoint"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__2__Value
            value: {{ .Values.queueProviders.amazonsqs.regionEndpoint | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueuePath
            value: {{ .Values.queueNames.listenerQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Assembly
            value: "RedPoint.Amazon.Server"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Type
            value: "RedPoint.Amazon.Server.AWSQueue.SQSQueueFactory"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Key
            value: "AccessKey"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Value
            value: {{ .Values.queueProviders.amazonsqs.accessKey | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__1__Key
            value: "SecretKey"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__1__Value
            value: {{ .Values.queueProviders.amazonsqs.secretKey | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__2__Key
            value: "RegionEndpoint"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__2__Value
            value: {{ .Values.queueProviders.amazonsqs.regionEndpoint | quote }}
          {{- end }}
          {{- if eq .Values.cacheProviders.type "mongodb" }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Name
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Assembly
            value: "RedPoint.Resonance.MongoDBCache"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Class
            value: "RedPoint.Resonance.MongoDBCache.MongoDBCacheHandler"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Key
            value: "Database"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Value
            value: {{ .Values.cacheProviders.mongodb.databaseName | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Key
            value: "ConnectionString"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Value
            value: {{ .Values.cacheProviders.mongodb.ConnectionString | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__2__Key
            value: "CollectionName"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__2__Value
            value: {{ .Values.cacheProviders.mongodb.CollectionName | quote }}
          {{- end }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Type
            value: "Visitor Profile"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorProfile.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorProfile.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Type
            value: "Visitor History"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorHistory.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorHistory.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Type
            value: "Non Visitor Data"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__DaysToPersist
            value: {{ .Values.realtime.DataMaps.NonVisitorData.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__CompressData
            value: {{ .Values.realtime.DataMaps.NonVisitorData.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Type
            value: "Product Recommendations"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__DaysToPersist
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__CompressData
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.CompressData | quote }}
          volumeMounts:
            {{- if .Values.realtime.enableConfigmap }}
            - name: rpi-realtimeapi
              mountPath: /app/appsettings
            {{- end }}
            - name: plugins
              mountPath: /app/plugins
      volumes:
        {{- if .Values.realtime.enableConfigmap }}
        - name: rpi-realtimeapi
          configMap:
            name: rpi-realtimeapi
        {{- end }}
        - name: plugins
          emptyDir: {}
      {{- with .Values.global.nodeSelector | default .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations | default .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

---
{{- if eq .Values.global.cloud "azure" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rpi-realtimeapi
  namespace: {{ .Values.global.namespace }}
  labels:
    app: rpi-realtimeapi
spec:
  replicas: {{ .Values.replicas.realtimeapi }}
  selector:
    matchLabels:
      app: rpi-realtimeapi
  template:
    metadata:
      labels:
        app: rpi-realtimeapi
    spec:
      imagePullSecrets:
        - name: redpoint-rpi
      serviceAccountName: redpoint-rpi
      containers:
        - name: rpi-realtimeapi
          image: rg1acrpub.azurecr.io/docker/redpointinteraction/prod/redpoint-realtime-plus-agent:{{ .Values.global.image_tag }}
          imagePullPolicy: Always
          ports:
          - containerPort: 8080
            name: web-port
            protocol: TCP
          env:
          - name: CONNECTIONSTRINGS__LOGGINGDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__LoggingDatabase
                name: database-secrets
          - name: CONNECTIONSTRINGS__OPERATIONALDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__OperationalDatabase
                name: database-secrets
          - name: RealtimeAPIConfiguration__AppSettings__PluginAssemblyPath
            value: {{ .Values.realtime.pluginAssemblyPath | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentInProcessEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__NoDaysPersistWebEvents
            value: {{ .Values.realtime.NoDaysPersistWebEvents | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CacheWebFormData
            value: {{ .Values.realtime.CacheWebFormData | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableHelpPages
            value: {{ .Values.realtime.enableHelpPages | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CORSOrigins
            value: {{ .Values.realtime.CORSOrigins | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__DecisionCacheDuration
            value: {{ .Values.realtime.decisionCacheDuration | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIClientID
            value: {{ .Values.realtime.rpiClientID | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAPIKey
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableAuditMetricsInHeaders
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__EnableEventListening
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__FormQueuePath
            value: {{ .Values.queueNames.formQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__EventsQueuePath
            value: {{ .Values.queueNames.eventsQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueueEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueuePath
            value: {{ .Values.queueNames.cacheOutputQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__RecommendationsQueuePath
            value: {{ .Values.queueNames.recommendationsQueuePath | quote }}
          {{- if eq .Values.queueProviders.type "azureservicebus" }}
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Assembly
            value: "RedPoint.Azure.Server"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Type
            value: "RedPoint.Azure.Server.AzureQueue.AzureServiceBusQueueFactory"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Key
            value: "QueueType"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Value
            value: "ServiceBus"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__1__Key
            value: "ConnectionString"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__1__Value
            value: {{ .Values.queueProviders.azureservicebus.connectionString | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueuePath
            value: {{ .Values.queueNames.listenerQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Assembly
            value: "RedPoint.Azure.Server"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Type
            value: "RedPoint.Azure.Server.AzureQueue.AzureServiceBusQueueFactory"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Key
            value: "QueueType"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Value
            value: "ServiceBus"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__1__Key
            value: "ConnectionString"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__1__Value
            value: {{ .Values.queueProviders.azureservicebus.connectionString | quote }}
          {{- end }}
          {{- if eq .Values.cacheProviders.type "mongodb" }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Name
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Assembly
            value: "RedPoint.Resonance.MongoDBCache"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Class
            value: "RedPoint.Resonance.MongoDBCache.MongoDBCacheHandler"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Key
            value: "Database"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Value
            value: {{ .Values.cacheProviders.mongodb.databaseName | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Key
            value: "ConnectionString"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Value
            value: {{ .Values.cacheProviders.mongodb.ConnectionString | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__2__Key
            value: "CollectionName"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__2__Value
            value: {{ .Values.cacheProviders.mongodb.CollectionName | quote }}
          {{- end }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Type
            value: "Visitor Profile"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorProfile.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorProfile.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Type
            value: "Visitor History"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorHistory.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorHistory.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Type
            value: "Non Visitor Data"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__DaysToPersist
            value: {{ .Values.realtime.DataMaps.NonVisitorData.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__CompressData
            value: {{ .Values.realtime.DataMaps.NonVisitorData.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Type
            value: "Product Recommendations"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__DaysToPersist
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__CompressData
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.CompressData | quote }}
          volumeMounts:
            {{- if .Values.realtime.enableConfigmap }}
            - name: rpi-realtimeapi
              mountPath: /app/appsettings
            {{- end }}
            - name: plugins
              mountPath: /app/plugins
      volumes:
        {{- if .Values.realtime.enableConfigmap }}
        - name: rpi-realtimeapi
          configMap:
            name: rpi-realtimeapi
        {{- end }}
        - name: plugins
          emptyDir: {}
      {{- with .Values.global.nodeSelector | default .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations | default .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

---
{{- if eq .Values.global.cloud "google" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rpi-realtimeapi
  namespace: {{ .Values.global.namespace }}
  labels:
    app: rpi-realtimeapi
spec:
  replicas: {{ .Values.replicas.realtimeapi }}
  selector:
    matchLabels:
      app: rpi-realtimeapi
  template:
    metadata:
      labels:
        app: rpi-realtimeapi
    spec:
      imagePullSecrets:
        - name: redpoint-rpi
      serviceAccountName: redpoint-rpi
      containers:
        - name: rpi-realtimeapi
          image: rg1acrpub.azurecr.io/docker/redpointinteraction/prod/redpoint-realtime-plus-agent:{{ .Values.global.image_tag }}
          imagePullPolicy: Always
          ports:
          - containerPort: 8080
            name: web-port
            protocol: TCP
          env:
          - name: CONNECTIONSTRINGS__LOGGINGDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__LoggingDatabase
                name: database-secrets
          - name: CONNECTIONSTRINGS__OPERATIONALDATABASE
            valueFrom:
              secretKeyRef:
                key: ConnectionStrings__OperationalDatabase
                name: database-secrets
          - name: RealtimeAPIConfiguration__AppSettings__PluginAssemblyPath
            value: {{ .Values.realtime.pluginAssemblyPath | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentInProcessEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAgentAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__NoDaysPersistWebEvents
            value: {{ .Values.realtime.NoDaysPersistWebEvents | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CacheWebFormData
            value: {{ .Values.realtime.CacheWebFormData | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableHelpPages
            value: {{ .Values.realtime.enableHelpPages | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__CORSOrigins
            value: {{ .Values.realtime.CORSOrigins | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__DecisionCacheDuration
            value: {{ .Values.realtime.decisionCacheDuration | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIClientID
            value: {{ .Values.realtime.rpiClientID | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RPIAuthToken
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__RealtimeAPIKey
            value: {{ .Values.realtime.rpiAuthToken | quote }}
          - name: RealtimeAPIConfiguration__AppSettings__EnableAuditMetricsInHeaders
            value: "true"
          - name: RealtimeAPIConfiguration__AppSettings__EnableEventListening
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__FormQueuePath
            value: {{ .Values.queueNames.formQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__EventsQueuePath
            value: {{ .Values.queueNames.eventsQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueueEnabled
            value: "true"
          - name: RealtimeAPIConfiguration__Queues__CacheOutputQueuePath
            value: {{ .Values.queueNames.cacheOutputQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__RecommendationsQueuePath
            value: {{ .Values.queueNames.recommendationsQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Assembly
            value: "RedPoint.Google.Server"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Type
            value: "RedPoint.Google.Server.GooglePubSub.GooglePubSubFactory"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Key
            value: "ProjectId"
          - name: RealtimeAPIConfiguration__Queues__ClientQueueSettings__Settings__0__Value
            value: {{ .Values.queueProviders.googlepubsub.projectId | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueuePath
            value: {{ .Values.queueNames.listenerQueuePath | quote }}
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Assembly
            value: "RedPoint.Google.Server"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Type
            value: "RedPoint.Google.Server.GooglePubSub.GooglePubSubFactory"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Key
            value: "ProjectId"
          - name: RealtimeAPIConfiguration__Queues__ListenerQueueSettings__Settings__0__Value
            value: {{ .Values.queueProviders.googlepubsub.projectId | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Name
            value: "GoogleBigTable"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Assembly
            value: "RedPoint.Google.Server"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Class
            value: "RedPoint.Google.Server.GoogleBigTableCache.GoogleBigTableCacheHandler"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Key
            value: "ProjectId"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__0__Value
            value: {{ .Values.queueProviders.googlepubsub.projectId | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Key
            value: "InstanceId"
          - name: RealtimeAPIConfiguration__CacheSettings__Caches__0__Settings__1__Value
            value: {{ .Values.cacheProviders.googlebigtable.InstanceId | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Type
            value: "Visitor Profile"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorProfile.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__0__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorProfile.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Type
            value: "Visitor History"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__DaysToPersist
            value: {{ .Values.realtime.DataMaps.VisitorHistory.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__1__CompressData
            value: {{ .Values.realtime.DataMaps.VisitorHistory.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Type
            value: "Non Visitor Data"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__DaysToPersist
            value: {{ .Values.realtime.DataMaps.NonVisitorData.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__2__CompressData
            value: {{ .Values.realtime.DataMaps.NonVisitorData.CompressData | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Type
            value: "Product Recommendations"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__Cache
            value: "Default"
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__DaysToPersist
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.DaysToPersist | quote }}
          - name: RealtimeAPIConfiguration__CacheSettings__DataMaps__3__CompressData
            value: {{ .Values.realtime.DataMaps.ProductRecommendation.CompressData | quote }}
          volumeMounts:
            {{- if .Values.realtime.enableConfigmap }}
            - name: rpi-realtimeapi
              mountPath: /app/appsettings
            {{- end }}
            - name: plugins
              mountPath: /app/plugins
      volumes:
        {{- if .Values.realtime.enableConfigmap }}
        - name: rpi-realtimeapi
          configMap:
            name: rpi-realtimeapi
        {{- end }}
        - name: plugins
          emptyDir: {}
      {{- with .Values.global.nodeSelector | default .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations | default .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}